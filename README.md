# Satellite Navigation Principles Lab 1

基于广播星历计算卫星位置的C++程序。

## 功能

- 解析RINEX混合广播星历文件（brdm3350.19p）
- 计算GPS/BDS卫星在任意时刻的ECEF坐标
- 支持GEO/MEO/IGSO卫星轨道类型区分处理
- 智能星历选择（处理重复TOE和异常数据）
- 时间系统自动转换（GPST/BDT）

## 文件说明

| 文件 | 说明 |
|------|------|
| `main.cpp` | 主程序源代码 |
| `brdm3350.19p` | RINEX混合广播星历文件（2019年第335天） |
| `WUM0MGXFIN_*.SP3` | IGS精密星历文件（用于精度验证） |
| `coordinates.txt` | 输出的卫星坐标结果 |

## 使用方法

```bash
g++ main.cpp -o main.exe -std=c++17
./main.exe
```

程序会读取`brdm3350.19p`文件，计算一天内（0-86400秒，每5分钟一个点）所有GPS和北斗卫星的坐标，输出到`coordinates.txt`。

---

# 开发日志

## 📅 2024-12-22

- ✅ **项目初始化**
  - 创建C++项目，配置编译环境
  - 设计数据结构：`TOC`、`Point3D`、`Ephemery`、`Satellite`类
  - 实现RINEX文件解析

- ✅ **基础卫星位置计算**
  - 实现开普勒轨道解算
  - 实现坐标输出到文件

---

### 🐛 Issue #1: 北斗卫星与精密星历对比误差过大

- **发现时间**: 2024-12-22
- **严重程度**: 高
- **问题描述**: 将程序计算的预报星历卫星位置与IGS发布的SP3精密星历进行对比验证。GPS卫星的3D位置误差在正常范围内（米级到十几米），但北斗卫星的误差异常大，达到数百公里甚至更多。
- **问题表现**:
  - GPS卫星误差正常（米级）
  - 北斗卫星误差异常（数百公里）
  - 误差与时间呈线性增长趋势
- **根本原因**:
  时间系统不一致：

  | 文件类型 | 北斗卫星使用的时间系统 |
  |---------|----------------------|
  | 广播星历（RINEX） | **BDT（北斗时）** |
  | 精密星历（SP3） | **GPST（GPS时）** |
  
  时间关系：**BDT = GPST - 14秒**（固定偏移）
- **原始代码**:

  ```cpp
  // 原代码未区分时间系统
  tk = t - TOE;
  ```

### ✅ 修复 Issue #1: 时间系统转换

- **状态**: ✅ 已修复
- **解决方案**:
  在计算归化时间tk时，对北斗卫星进行时间系统补偿：

  ```cpp
  double tk;
  if(PRN[0]=='C'){
      tk = t - TOE - 14;  // 北斗卫星：GPST → BDT
  } else {
      tk = t - TOE;       // GPS卫星
  }
  ```

- **修改位置**: `main.cpp` Ephemery::calc_coordinate() 函数开头 → [查看代码](file:///d:/卫星导航/艾周围2024302142029——第一次实习/main.cpp#L124-L131)
- **验证结果**:
  - ✅ 北斗卫星误差降至与GPS卫星相当水平

---

### 🐛 Issue #2: 部分卫星轨迹出现诡异突变

- **发现时间**: 2024-12-22
- **严重程度**: 高
- **问题描述**: 在MATLAB中绑制卫星轨迹图时，发现部分北斗卫星（如C36）的轨迹出现不连续的跳变，坐标在某些时刻突然跃迁到完全不同的位置。
- **调试过程**:
  添加调试输出，打印异常时刻使用的星历参数：

  ```cpp
  if(sat.PRN == "C36" && t == 41400) {
      cout << "使用的星历 TOE = " << best_ephem->TOE << endl;
      cout << "sqrt(A) = " << best_ephem->sqrt_A << endl;
      // ... 其他参数
  }
  ```

- **根本原因**:
  1. 广播星历文件中，同一卫星在同一TOE时刻存在**多条星历记录**
  2. 这些星历的轨道参数可能完全不同，部分存在**异常值**
  3. 原代码只按TOE差值选择，无法区分数据质量
- **老师建议**: 如果多个星历TOE相同，选择**toc与toe接近**的那个
- **原始代码**:

  ```cpp
  // 只按TOE差值选择，无法区分数据质量
  for(auto& ephem : sat.Ephemerys){
      double time_diff = fabs(ephem.TOE - t);
      if(time_diff < min_time_diff){
          min_time_diff = time_diff;
          best_ephem = &ephem;
      }
  }
  ```

### ✅ 修复 Issue #2: 智能星历选择

- **状态**: ✅ 已修复
- **解决方案**:
  1. 添加`toc_to_gps_seconds()`函数，将toc转为周内秒
  2. 修改星历选择逻辑，添加toc-toe二级筛选：

  ```cpp
  if(time_diff < min_time_diff){
      min_time_diff = time_diff;
      min_toc_toe_diff = toc_toe_diff;
      best_ephem = &ephem;
  } else if(time_diff == min_time_diff && toc_toe_diff < min_toc_toe_diff){
      // TOE相同时，选择toc与toe更接近的星历
      min_toc_toe_diff = toc_toe_diff;
      best_ephem = &ephem;
  }
  ```

- **修改位置**: `main.cpp` main()函数中的星历选择逻辑 → [查看代码](file:///d:/卫星导航/艾周围2024302142029——第一次实习/main.cpp#L330-L354)
- **验证结果**:
  - ✅ C36等卫星轨迹恢复正常

---

### ✨ 改进 #1: GEO卫星坐标变换

- **类型**: 主动改进
- **背景**: 查阅北斗ICD接口控制文件（B1I 3.0版），发现**GEO卫星**坐标计算需要额外变换
- **北斗卫星轨道类型**:

  | 轨道类型 | PRN编号 | 说明 |
  |---------|---------|------|
  | **GEO** | C01-C05, C59-C63 | 地球静止轨道，需特殊处理 |
  | **IGSO** | C06-C10, C13, C16, C38-C40 | 倾斜地球同步轨道 |
  | **MEO** | C11-C12, C14, C19-C37, C41-C46 | 中圆地球轨道 |

- **实现内容**:
  1. 根据PRN编号判断GEO卫星
  2. 计算惯性系坐标
  3. 地球自转修正（绕Z轴旋转ωe·tk）
  4. 绕X轴旋转-5°
- **修改位置**: `main.cpp` Ephemery::calc_coordinate()函数 → [查看代码](file:///d:/卫星导航/艾周围2024302142029——第一次实习/main.cpp#L174-L200)

---

### 🐛 Issue #3: C31/C32卫星依然异常

- **发现时间**: 2024-12-22
- **严重程度**: 中（数据质量问题，非程序逻辑）
- **问题描述**: 完成上述所有修改后，C31和C32两颗卫星的轨迹仍然存在明显跳变。
- **分析工具**: 使用Python脚本分析原始星历数据 (`analyze_c31_c32.py`)

#### C31问题：星历数据严重稀疏

C31在整个广播星历文件中只有4条星历记录：

| 序号 | TOE (周内秒) | 对应时间 |
|-----|-------------|---------|
| 1 | 14400 | 04:00 |
| 2 | 21600 | 06:00 |
| 3 | 50400 | 14:00 |
| 4 | 75600 | 21:00 |

**问题**:

- 06:00到14:00之间有**8小时空白**
- 星历有效期一般是±2小时
- 4条星历之间轨道参数**不连续**

**轨道参数跳变分析**:

| 跳变时刻 | 跳变参数 | 跳变量 |
|---------|---------|--------|
| t≈18000s | omega | 从-0.62rad变为+0.05rad，差0.67rad(38°) |
| t≈36000s | M0, omega | 同时大幅跳变 |
| t≈63000s | Omega0 | 从-2.89rad变为+1.27rad，差4.16rad(238°) |

#### C32问题：同TOE存在多条冲突星历

| TOE | 问题描述 |
|-----|---------|
| 14400 | 有3条完全不同的星历 |
| 18000 | 有2条不同的星历 |
| 72000 | 其中一条sqrt_A=6492.92（异常值，正常应为5282） |

TOE=72000的两条星历对比：

- 正常星历：sqrt_A=5282.62 → 轨道半径27.91万km
- 异常星历：sqrt_A=6492.92 → 轨道半径42.16万km（GEO高度！）

### 📋 Issue #3 结论

C31和C32的轨迹异常是**广播星历文件本身的数据质量问题**，不是程序逻辑错误：

1. **C31**: 星历稀疏且参数不连续（可能是卫星机动或数据上注异常）
2. **C32**: 同一TOE存在多条完全不同的星历，toc-toe筛选逻辑对这种情况作用有限

---

<!-- 
后续问题解决记录模板：

### 🐛 Issue #X: [问题名称]

- **发现时间**: YYYY-MM-DD HH:MM
- **严重程度**: 高/中/低
- **问题描述**: 
- **问题表现**:
- **根本原因**:
- **相关文件**: 

### ✅ 修复 Issue #X: [问题名称]

- **状态**: ✅ 已修复
- **解决方案**:
- **修改位置**: 
- **验证结果**:
-->
