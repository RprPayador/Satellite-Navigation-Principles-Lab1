# 调试过程记录：星历异常问题排查

## 问题现象

在与SP3精密星历对比验证时，发现部分北斗卫星（如C36）在某些时刻的计算坐标与精密星历偏差异常大，而其他时刻及其他卫星的误差在正常范围内。

## 调试方法

### 1. 添加调试输出

在代码中针对异常卫星和时间点添加详细输出：

```cpp
if(sat.PRN == "C36" && t == 41400) {
    cout << "\n===========================\n";
    cout << " C36 调试信息 t = " << t << " 秒\n";
    cout << "===========================\n";

    if(best_ephem) {
        cout << "使用的星历 TOE = " << best_ephem->TOE
             << "   (与 t 的差 min_time_diff = " << min_time_diff << ")\n\n";

        cout << "星历参数：\n";
        cout << "  sqrt(A)     = " << best_ephem->sqrt_A << "\n";
        cout << "  e           = " << best_ephem->e << "\n";
        cout << "  i0          = " << best_ephem->i_0 << "\n";
        cout << "  idot        = " << best_ephem->i_dot << "\n";
        cout << "  Omega0      = " << best_ephem->Omega << "\n";
        cout << "  Omega_dot   = " << best_ephem->Omega_dot << "\n";
        cout << "  omega       = " << best_ephem->omega << "\n";
        cout << "  Cuc, Cus    = " << best_ephem->C_uc << " , " << best_ephem->C_us << "\n";
        cout << "  Cic, Cis    = " << best_ephem->C_ic << " , " << best_ephem->C_is << "\n";
        cout << "  Crc, Crs    = " << best_ephem->C_rc << " , " << best_ephem->C_rs << "\n";
        cout << "  Delta_n     = " << best_ephem->Delta_n << "\n";
        cout << "  M0          = " << best_ephem->M_0 << "\n";

        Point3D pos = best_ephem->calc_coordinate(t);
        cout << "\n计算后的坐标：\n";
        cout << "  X = " << pos.x << "\n";
        cout << "  Y = " << pos.y << "\n";
        cout << "  Z = " << pos.z << "\n";
        cout << "===========================\n\n";
    }
}
```

### 2. 发现问题

通过调试输出发现：

- 同一卫星在同一TOE时刻存在**多条星历记录**
- 其中一条星历的轨道参数（如 `sqrt_A`, `e` 等）存在异常值
- 原代码只按TOE与观测时间差选择星历，无法排除异常数据

### 3. 验证方法

对比同一TOE的多条星历，检查其 `toc`（钟差参考时间）与 `toe` 的差值：

- 正常星历：`toc` 与 `toe` 相同或非常接近
- 异常星历：`toc` 与 `toe` 差距较大

### 4. 解决方案

修改星历选择逻辑：当多条星历的TOE相同时，优先选择 `toc` 与 `toe` 差值最小的星历。

## 调试输出示例

```text
===========================
 C36 调试信息 t = 41400 秒
===========================
使用的星历 TOE = 43200   (与 t 的差 min_time_diff = 1800)

星历参数：
  sqrt(A)     = 6493.65
  e           = 0.000822444
  i0          = 0.956077
  idot        = 3.12874e-10
  Omega0      = 2.8932
  Omega_dot   = -6.62242e-09
  omega       = ...
  Cuc, Cus    = 2.27895e-06 , 8.9020e-06
  Cic, Cis    = ...
  Crc, Crs    = 178.938 , 44.1094
  Delta_n     = 3.75373e-09
  M0          = 2.97119

计算后的坐标：
  X = -7.12575e+06
  Y = 1.44888e+07
  Z = 2.27885e+07
===========================
```

## 经验总结

1. **问题定位**：通过添加详细调试输出，逐步缩小问题范围
2. **多源验证**：将计算结果与精密星历对比，确认异常点
3. **根因分析**：发现广播星历文件中同一TOE可能存在多条记录
4. **解决思路**：利用 `toc` 与 `toe` 的一致性作为数据质量判断依据
